---
description: Supabase API patterns and database conventions
globs:
  - 'apps/suref-web/src/lib/api/**/*.ts'
  - 'apps/suref-web/src/lib/supabase*.ts'
alwaysApply: false
---

Supabase API patterns for client setup, queries, validation, and hydration.

- Use `supabase` client from `src/lib/supabase.ts` for client-side operations, use `getSupabaseServerClient()` from `src/lib/supabase.server.ts` for server-side operations, always type the client with `Database` type from `database-generated.types.ts`
- All API functions live in `src/lib/api/`, group by resource: `entities.ts`, `pilots.ts`, `mechs.ts`, `cargo.ts`, etc., use async/await (never callbacks), always handle errors (throw or return error objects)
- Use typed queries: `supabase.from('table_name').select('*')`, always use `.single()` for single row queries, use `.eq()`, `.in()`, `.order()` for filtering and sorting, cast results with `castDatabaseResult<T>()` helper when needed
- Use Zod schemas for input validation (in `src/lib/validation/`), validate before database operations, export schemas for reuse in forms
- For normalized entities (`suentities` table): Use `hydrateEntity()` or `hydrateEntities()` from `src/lib/api/hydration.ts`, fetch related `player_choices` and merge into hydrated entity, return `HydratedEntity` type which includes choices array
- Throw errors (don't return error objects), use descriptive error messages, let TanStack Query handle error states in components
- Fetch with filtering: `const { data, error } = await supabase.from(table).select('*').eq('user_id' as never, userId); if (error) throw error; return castDatabaseResult<T[]>(data || [])`
- Create with validation: `const validated = createEntitySchema.parse(data); const { data: entity, error } = await supabase.from('suentities').insert(validated).select().single(); if (error) throw new Error(\`Failed to create entity: ${error.message}\`); return hydrateEntity(entity, [])`
- Use `useRealtimeSubscription` hook for realtime updates, always provide `queryKey` for cache invalidation, show toast notifications for updates (configurable)
